'use strict';

require('babel-polyfill');
require('source-map-support/register');

Object.defineProperty(exports, "__esModule", {
  value: true
});

var _createClass = function () { function defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if ("value" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } } return function (Constructor, protoProps, staticProps) { if (protoProps) defineProperties(Constructor.prototype, protoProps); if (staticProps) defineProperties(Constructor, staticProps); return Constructor; }; }();

var _fs = require('fs');

var _fs2 = _interopRequireDefault(_fs);

var _path = require('path');

var _path2 = _interopRequireDefault(_path);

var _nodemiral = require('nodemiral');

var _nodemiral2 = _interopRequireDefault(_nodemiral);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError("Cannot call a class as a function"); } }

var MupAPI = function () {
  function MupAPI(base, args, configPath, settingsPath) {
    _classCallCheck(this, MupAPI);

    this.base = base;
    this.args = args;
    this.config = null;
    this.settings = null;
    this.sessions = null;
    this.configPath = configPath;
    this.settingsPath = settingsPath;
  }

  _createClass(MupAPI, [{
    key: 'getArgs',
    value: function getArgs() {
      return this.args;
    }
  }, {
    key: 'getBasePath',
    value: function getBasePath() {
      return this.base;
    }
  }, {
    key: 'getConfig',
    value: function getConfig() {
      if (!this.config) {
        var filePath = void 0;
        if (this.configPath) {
          filePath = _path2.default.resolve(this.configPath);
          this.base = _path2.default.dirname(this.configPath);
        } else {
          filePath = _path2.default.join(this.base, 'mup.js');
        }
        try {
          this.config = require(filePath);
        } catch (e) {
          if (e.code == 'MODULE_NOT_FOUND') {
            console.error('\'mup.js\' file not found. Run \'mup init\' first.');
          } else {
            console.error(e);
          }
          process.exit(1);
        }
      }

      return this.config;
    }
  }, {
    key: 'getSettings',
    value: function getSettings() {
      if (!this.settings) {
        var filePath = void 0;
        if (this.settingsPath) {
          filePath = _path2.default.resolve(this.settingsPath);
        } else {
          filePath = _path2.default.join(this.base, 'settings.json');
        }
        this.settings = require(filePath);
      }

      return this.settings;
    }
  }, {
    key: 'getSessions',
    value: function getSessions() {
      var modules = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : [];

      var sessions = this._pickSessions(modules);
      return Object.keys(sessions).map(function (name) {
        return sessions[name];
      });
    }
  }, {
    key: 'withSessions',
    value: function withSessions() {
      var modules = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : [];

      var api = Object.create(this);
      api.sessions = this._pickSessions(modules);
      return api;
    }
  }, {
    key: '_pickSessions',
    value: function _pickSessions() {
      var _this = this;

      var modules = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : [];

      if (!this.sessions) {
        this._loadSessions();
      }

      var sessions = {};

      modules.forEach(function (moduleName) {
        var moduleConfig = _this.config[moduleName];
        if (!moduleConfig) {
          return;
        }

        for (var name in moduleConfig.servers) {
          if (!moduleConfig.servers.hasOwnProperty(name)) {
            continue;
          }

          if (_this.sessions[name]) {
            sessions[name] = _this.sessions[name];
          }
        }
      });

      return sessions;
    }
  }, {
    key: '_loadSessions',
    value: function _loadSessions() {
      var config = this.getConfig();
      this.sessions = {};

      // `mup.servers` contains login information for servers
      // Use this information to create nodemiral sessions.
      for (var name in config.servers) {
        if (!config.servers.hasOwnProperty(name)) {
          continue;
        }

        var info = config.servers[name];
        var auth = { username: info.username };
        var opts = { ssh: {} };

        var sshAgent = process.env.SSH_AUTH_SOCK;

        if (info.opts) {
          opts.ssh = info.opts;
        }

        if (info.pem) {
          auth.pem = _fs2.default.readFileSync(_path2.default.resolve(info.pem), 'utf8');
        } else if (info.password) {
          auth.password = info.password;
        } else if (sshAgent && _fs2.default.existsSync(sshAgent)) {
          opts.ssh.agent = sshAgent;
        } else {
          console.error('error: server %s doesn\'t have password, ssh-agent or pem', name);
          process.exit(1);
        }

        var session = _nodemiral2.default.session(info.host, auth, opts);
        this.sessions[name] = session;
      }
    }
  }]);

  return MupAPI;
}();

exports.default = MupAPI;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIm11cC1hcGkuanMiXSwibmFtZXMiOlsiTXVwQVBJIiwiYmFzZSIsImFyZ3MiLCJjb25maWdQYXRoIiwic2V0dGluZ3NQYXRoIiwiY29uZmlnIiwic2V0dGluZ3MiLCJzZXNzaW9ucyIsImZpbGVQYXRoIiwicmVzb2x2ZSIsImRpcm5hbWUiLCJqb2luIiwicmVxdWlyZSIsImUiLCJjb2RlIiwiY29uc29sZSIsImVycm9yIiwicHJvY2VzcyIsImV4aXQiLCJtb2R1bGVzIiwiX3BpY2tTZXNzaW9ucyIsIk9iamVjdCIsImtleXMiLCJtYXAiLCJuYW1lIiwiYXBpIiwiY3JlYXRlIiwiX2xvYWRTZXNzaW9ucyIsImZvckVhY2giLCJtb2R1bGVDb25maWciLCJtb2R1bGVOYW1lIiwic2VydmVycyIsImhhc093blByb3BlcnR5IiwiZ2V0Q29uZmlnIiwiaW5mbyIsImF1dGgiLCJ1c2VybmFtZSIsIm9wdHMiLCJzc2giLCJzc2hBZ2VudCIsImVudiIsIlNTSF9BVVRIX1NPQ0siLCJwZW0iLCJyZWFkRmlsZVN5bmMiLCJwYXNzd29yZCIsImV4aXN0c1N5bmMiLCJhZ2VudCIsInNlc3Npb24iLCJob3N0Il0sIm1hcHBpbmdzIjoiOzs7Ozs7OztBQUFBOzs7O0FBQ0E7Ozs7QUFDQTs7Ozs7Ozs7SUFFcUJBLE07QUFDbkIsa0JBQVlDLElBQVosRUFBa0JDLElBQWxCLEVBQXdCQyxVQUF4QixFQUFvQ0MsWUFBcEMsRUFBa0Q7QUFBQTs7QUFDaEQsU0FBS0gsSUFBTCxHQUFZQSxJQUFaO0FBQ0EsU0FBS0MsSUFBTCxHQUFZQSxJQUFaO0FBQ0EsU0FBS0csTUFBTCxHQUFjLElBQWQ7QUFDQSxTQUFLQyxRQUFMLEdBQWdCLElBQWhCO0FBQ0EsU0FBS0MsUUFBTCxHQUFnQixJQUFoQjtBQUNBLFNBQUtKLFVBQUwsR0FBa0JBLFVBQWxCO0FBQ0EsU0FBS0MsWUFBTCxHQUFvQkEsWUFBcEI7QUFDRDs7Ozs4QkFFUztBQUNSLGFBQU8sS0FBS0YsSUFBWjtBQUNEOzs7a0NBRWE7QUFD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ZW9yLXVwL3NyYyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBmcyBmcm9tICdmcyc7XG5pbXBvcnQgcGF0aCBmcm9tICdwYXRoJztcbmltcG9ydCBub2RlbWlyYWwgZnJvbSAnbm9kZW1pcmFsJztcblxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgTXVwQVBJIHtcbiAgY29uc3RydWN0b3IoYmFzZSwgYXJncywgY29uZmlnUGF0aCwgc2V0dGluZ3NQYXRoKSB7XG4gICAgdGhpcy5iYXNlID0gYmFzZTtcbiAgICB0aGlzLmFyZ3MgPSBhcmdzO1xuICAgIHRoaXMuY29uZmlnID0gbnVsbDtcbiAgICB0aGlzLnNldHRpbmdzID0gbnVsbDtcbiAgICB0aGlzLnNlc3Npb25zID0gbnVsbDtcbiAgICB0aGlzLmNvbmZpZ1BhdGggPSBjb25maWdQYXRoO1xuICAgIHRoaXMuc2V0dGluZ3NQYXRoID0gc2V0dGluZ3NQYXRoO1xuICB9XG5cbiAgZ2V0QXJncygpIHtcbiAgICByZXR1cm4gdGhpcy5hcmdzO1xuICB9XG5cbiAgZ2V0QmFzZVBhdGgoKSB7XG4gICAgcmV0dXJuIHRoaXMuYmFzZTtcbiAgfVxuXG4gIGdldENvbmZpZygpIHtcbiAgICBpZiAoIXRoaXMuY29uZmlnKSB7XG4gICAgICBsZXQgZmlsZVBhdGg7XG4gICAgICBpZih0aGlzLmNvbmZpZ1BhdGgpIHtcbiAgICAgICAgZmlsZVBhdGggPSBwYXRoLnJlc29sdmUodGhpcy5jb25maWdQYXRoKTtcbiAgICAgICAgdGhpcy5iYXNlID0gcGF0aC5kaXJuYW1lKHRoaXMuY29uZmlnUGF0aCk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBmaWxlUGF0aCA9IHBhdGguam9pbih0aGlzLmJhc2UsICdtdXAuanMnKTtcbiAgICAgIH1cbiAgICAgIHRyeSB7XG4gICAgICAgIHRoaXMuY29uZmlnID0gcmVxdWlyZShmaWxlUGF0aCk7XG4gICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgIGlmKGUuY29kZSA9PSAnTU9EVUxFX05PVF9GT1VORCcpIHtcbiAgICAgICAgICBjb25zb2xlLmVycm9yKGAnbXVwLmpzJyBmaWxlIG5vdCBmb3VuZC4gUnVuICdtdXAgaW5pdCcgZmlyc3QuYCk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgY29uc29sZS5lcnJvcihlKTtcbiAgICAgICAgfVxuICAgICAgICBwcm9jZXNzLmV4aXQoMSk7XG4gICAgICB9XG4gICAgfVxuXG4gICAgcmV0dXJuIHRoaXMuY29uZmlnO1xuICB9XG5cbiAgZ2V0U2V0dGluZ3MoKSB7XG4gICAgaWYgKCF0aGlzLnNldHRpbmdzKSB7XG4gICAgICBsZXQgZmlsZVBhdGg7XG4gICAgICBpZih0aGlzLnNldHRpbmdzUGF0aCkge1xuICAgICAgICBmaWxlUGF0aCA9IHBhdGgucmVzb2x2ZSh0aGlzLnNldHRpbmdzUGF0aCk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBmaWxlUGF0aCA9IHBhdGguam9pbih0aGlzLmJhc2UsICdzZXR0aW5ncy5qc29uJyk7XG4gICAgICB9XG4gICAgICB0aGlzLnNldHRpbmdzID0gcmVxdWlyZShmaWxlUGF0aCk7XG4gICAgfVxuXG4gICAgcmV0dXJuIHRoaXMuc2V0dGluZ3M7XG4gIH1cblxuICBnZXRTZXNzaW9ucyhtb2R1bGVzID0gW10pIHtcbiAgICBjb25zdCBzZXNzaW9ucyA9IHRoaXMuX3BpY2tTZXNzaW9ucyhtb2R1bGVzKTtcbiAgICByZXR1cm4gT2JqZWN0LmtleXMoc2Vzc2lvbnMpLm1hcChuYW1lID0+IHNlc3Npb25zW25hbWVdKTtcbiAgfVxuXG4gIHdpdGhTZXNzaW9ucyhtb2R1bGVzID0gW10pIHtcbiAgICBjb25zdCBhcGkgPSBPYmplY3QuY3JlYXRlKHRoaXMpO1xuICAgIGFwaS5zZXNzaW9ucyA9IHRoaXMuX3BpY2tTZXNzaW9ucyhtb2R1bGVzKTtcbiAgICByZXR1cm4gYXBpO1xuICB9XG5cbiAgX3BpY2tTZXNzaW9ucyhtb2R1bGVzID0gW10pIHtcbiAgICBpZiAoIXRoaXMuc2Vzc2lvbnMpIHtcbiAgICAgIHRoaXMuX2xvYWRTZXNzaW9ucygpO1xuICAgIH1cblxuICAgIGNvbnN0IHNlc3Npb25zID0ge307XG5cbiAgICBtb2R1bGVzLmZvckVhY2gobW9kdWxlTmFtZSA9PiB7XG4gICAgICBjb25zdCBtb2R1bGVDb25maWcgPSB0aGlzLmNvbmZpZ1ttb2R1bGVOYW1lXTtcbiAgICAgIGlmICghbW9kdWxlQ29uZmlnKSB7XG4gICAgICAgIHJldHVybjtcbiAgICAgIH1cblxuICAgICAgZm9yICh2YXIgbmFtZSBpbiBtb2R1bGVDb25maWcuc2VydmVycykge1xuICAgICAgICBpZiAoIW1vZHVsZUNvbmZpZy5zZXJ2ZXJzLmhhc093blByb3BlcnR5KG5hbWUpKSB7XG4gICAgICAgICAgY29udGludWU7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAodGhpcy5zZXNzaW9uc1tuYW1lXSkge1xuICAgICAgICAgIHNlc3Npb25zW25hbWVdID0gdGhpcy5zZXNzaW9uc1tuYW1lXTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH0pO1xuXG4gICAgcmV0dXJuIHNlc3Npb25zO1xuICB9XG5cbiAgX2xvYWRTZXNzaW9ucygpIHtcbiAgICBjb25zdCBjb25maWcgPSB0aGlzLmdldENvbmZpZygpO1xuICAgIHRoaXMuc2Vzc2lvbnMgPSB7fTtcblxuICAgIC8vIGBtdXAuc2VydmVyc2AgY29udGFpbnMgbG9naW4gaW5mb3JtYXRpb24gZm9yIHNlcnZlcnNcbiAgICAvLyBVc2UgdGhpcyBpbmZvcm1hdGlvbiB0byBjcmVhdGUgbm9kZW1pcmFsIHNlc3Npb25zLlxuICAgIGZvciAodmFyIG5hbWUgaW4gY29uZmlnLnNlcnZlcnMpIHtcbiAgICAgIGlmICghY29uZmlnLnNlcnZlcnMuaGFzT3duUHJvcGVydHkobmFtZSkpIHtcbiAgICAgICAgY29udGludWU7XG4gICAgICB9XG5cbiAgICAgIGNvbnN0IGluZm8gPSBjb25maWcuc2VydmVyc1tuYW1lXTtcbiAgICAgIGNvbnN0IGF1dGggPSB7dXNlcm5hbWU6IGluZm8udXNlcm5hbWV9O1xuICAgICAgY29uc3Qgb3B0cyA9IHtzc2g6IHt9fTtcblxuICAgICAgdmFyIHNzaEFnZW50ID0gcHJvY2Vzcy5lbnYuU1NIX0FVVEhfU09DSztcblxuICAgICAgaWYgKGluZm8ub3B0cykge1xuICAgICAgICBvcHRzLnNzaCA9IGluZm8ub3B0cztcbiAgICAgIH1cblxuICAgICAgaWYgKGluZm8ucGVtKSB7XG4gICAgICAgIGF1dGgucGVtID0gZnMucmVhZEZpbGVTeW5jKHBhdGgucmVzb2x2ZShpbmZvLnBlbSksICd1dGY4Jyk7XG4gICAgICB9IGVsc2UgaWYgKGluZm8ucGFzc3dvcmQpIHtcbiAgICAgICAgYXV0aC5wYXNzd29yZCA9IGluZm8ucGFzc3dvcmQ7XG4gICAgICB9IGVsc2UgaWYgKHNzaEFnZW50ICYmIGZzLmV4aXN0c1N5bmMoc3NoQWdlbnQpKSB7XG4gICAgICAgIG9wdHMuc3NoLmFnZW50ID0gc3NoQWdlbnQ7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBjb25zb2xlLmVycm9yKFxuICAgICAgICAgICdlcnJvcjogc2VydmVyICVzIGRvZXNuXFwndCBoYXZlIHBhc3N3b3JkLCBzc2gtYWdlbnQgb3IgcGVtJyxcbiAgICAgICAgICBuYW1lXG4gICAgICAgICk7XG4gICAgICAgIHByb2Nlc3MuZXhpdCgxKTtcbiAgICAgIH1cblxuICAgICAgY29uc3Qgc2Vzc2lvbiA9IG5vZGVtaXJhbC5zZXNzaW9uKGluZm8uaG9zdCwgYXV0aCwgb3B0cyk7XG4gICAgICB0aGlzLnNlc3Npb25zW25hbWVdID0gc2Vzc2lvbjtcbiAgICB9XG4gIH1cbn1cbiJdfQ==