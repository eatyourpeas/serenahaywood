'use strict';

require('babel-polyfill');
require('source-map-support/register');

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.runTaskList = runTaskList;
exports.getDockerLogs = getDockerLogs;
exports.runSSHCommand = runSSHCommand;
exports.countOccurences = countOccurences;

var _fs = require('fs');

var _fs2 = _interopRequireDefault(_fs);

var _underscore = require('underscore');

var _ = _interopRequireWildcard(_underscore);

var _bluebird = require('bluebird');

var _ssh = require('ssh2');

var _path = require('path');

var _path2 = _interopRequireDefault(_path);

function _interopRequireWildcard(obj) { if (obj && obj.__esModule) { return obj; } else { var newObj = {}; if (obj != null) { for (var key in obj) { if (Object.prototype.hasOwnProperty.call(obj, key)) newObj[key] = obj[key]; } } newObj.default = obj; return newObj; } }

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function runTaskList(list, sessions, opts) {
  return new Promise(function (resolve, reject) {
    list.run(sessions, opts, function (summaryMap) {
      for (var host in summaryMap) {
        var summary = summaryMap[host];
        if (summary.error) {
          reject(summary.error);
          return;
        }
      }

      resolve();
    });
  });
}

function getDockerLogs(name, sessions, args) {
  var command = 'sudo docker ' + args.join(' ') + ' ' + name;

  var promises = _.map(sessions, function (session) {
    var host = '[' + session._host + ']';
    var options = {
      onStdout: function onStdout(data) {
        process.stdout.write(host + data);
      },
      onStderr: function onStderr(data) {
        process.stdout.write(host + data);
      }
    };
    return (0, _bluebird.promisify)(session.execute.bind(session))(command, options);
  });
  return Promise.all(promises);
}

// Maybe we should create a new npm package
// for this one. Something like 'sshelljs'.
function runSSHCommand(info, command) {
  return new Promise(function (resolve, reject) {
    var conn = new _ssh.Client();

    // TODO better if we can extract SSH agent info from original session
    var sshAgent = process.env.SSH_AUTH_SOCK;
    var ssh = {
      host: info.host,
      port: info.opts && info.opts.port || 22,
      username: info.username
    };

    if (info.pem) {
      ssh.privateKey = _fs2.default.readFileSync(_path2.default.resolve(info.pem), 'utf8');
    } else if (info.password) {
      ssh.password = info.password;
    } else if (sshAgent && _fs2.default.existsSync(sshAgent)) {
      ssh.agent = sshAgent;
    }
    conn.connect(ssh);

    conn.once('error', function (err) {
      if (err) {
        reject(err);
      }
    });

    // TODO handle error events
    conn.once('ready', function () {
      conn.exec(command, function (err, stream) {
        if (err) {
          conn.end();
          reject(err);
          return;
        }

        var output = '';

        stream.on('data', function (data) {
          output += data;
        });

        stream.once('close', function (code) {
          conn.end();
          resolve({ code: code, output: output });
        });
      });
    });
  });
}

function countOccurences(needle, haystack) {
  var regex = new RegExp(needle, 'g');
  var match = haystack.match(regex) || [];
  return match.length;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInV0aWxzLmpzIl0sIm5hbWVzIjpbInJ1blRhc2tMaXN0IiwiZ2V0RG9ja2VyTG9ncyIsInJ1blNTSENvbW1hbmQiLCJjb3VudE9jY3VyZW5jZXMiLCJfIiwibGlzdCIsInNlc3Npb25zIiwib3B0cyIsIlByb21pc2UiLCJyZXNvbHZlIiwicmVqZWN0IiwicnVuIiwiaG9zdCIsInN1bW1hcnlNYXAiLCJzdW1tYXJ5IiwiZXJyb3IiLCJuYW1lIiwiYXJncyIsImNvbW1hbmQiLCJqb2luIiwicHJvbWlzZXMiLCJtYXAiLCJzZXNzaW9uIiwiX2hvc3QiLCJvcHRpb25zIiwib25TdGRvdXQiLCJwcm9jZXNzIiwic3Rkb3V0Iiwid3JpdGUiLCJkYXRhIiwib25TdGRlcnIiLCJleGVjdXRlIiwiYmluZCIsImFsbCIsImluZm8iLCJjb25uIiwic3NoQWdlbnQiLCJlbnYiLCJTU0hfQVVUSF9TT0NLIiwic3NoIiwicG9ydCIsInVzZXJuYW1lIiwicGVtIiwicHJpdmF0ZUtleSIsInJlYWRGaWxlU3luYyIsInBhc3N3b3JkIiwiZXhpc3RzU3luYyIsImFnZW50IiwiY29ubmVjdCIsIm9uY2UiLCJlcnIiLCJleGVjIiwic3RyZWFtIiwiZW5kIiwib3V0cHV0Iiwib24iLCJjb2RlIiwibmVlZGxlIiwiaGF5c3RhY2siLCJyZWdleCIsIlJlZ0V4cCIsIm1hdGNoIiwibGVuZ3RoIl0sIm1hcHBpbmdzIjoiOzs7OztRQU1nQkEsVyxHQUFBQSxXO1FBZ0JBQyxhLEdBQUFBLGE7UUFvQkFDLGEsR0FBQUEsYTtRQW1EQUMsZSxHQUFBQSxlOztBQTdGaEI7Ozs7QUFDQTs7SUFBWUMsQzs7QUFDWjs7QUFDQTs7QUFDQTs7Ozs7Ozs7QUFFTyxTQUFTSixXQUFULENBQXFCSyxJQUFyQixFQUEyQkMsUUFBM0IsRUFBcUNDLElBQXJDLEVBQTJDO0FBQ2hELFNBQU8sSUFBSUMsT0FBSixDQUFZLFVBQUNDLE9BQUQsRUFBVUMsTUFBVixFQUFxQjtBQUN0Q0wsU0FBS00sR0FBTCxDQUFTTCxR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SUFBVjtBQUNELFNBRkQ7O0FBSUF1QixlQUFPSCxJQUFQLENBQVksT0FBWixFQUFxQixVQUFVTyxJQUFWLEVBQWdCO0FBQ25DckIsZUFBS2tCLEdBQUw7QUFDQTVDLGtCQUFRLEVBQUMrQyxVQUFELEVBQU9GLGNBQVAsRUFBUjtBQUNELFNBSEQ7QUFJRCxPQWpCRDtBQWtCRCxLQW5CRDtBQW9CRCxHQS9DTSxDQUFQO0FBZ0REOztBQUVNLFNBQVNuRCxlQUFULENBQXlCc0QsTUFBekIsRUFBaUNDLFFBQWpDLEVBQTJDO0FBQ2hELE1BQU1DLFFBQVEsSUFBSUMsTUFBSixDQUFXSCxNQUFYLEVBQW1CLEdBQW5CLENBQWQ7QUFDQSxNQUFNSSxRQUFRSCxTQUFTRyxLQUFULENBQWVGLEtBQWYsS0FBeUIsRUFBdkM7QUFDQSxTQUFPRSxNQUFNQyxNQUFiO0FBQ0QiLCJmaWxlIjoidXRpbHMuanMiLCJzb3VyY2VSb290IjoiL2hvbWUvbWFkdXNoYW4vbWV0ZW9yLXVwL3NyYyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBmcyBmcm9tICdmcyc7XG5pbXBvcnQgKiBhcyBfIGZyb20gJ3VuZGVyc2NvcmUnO1xuaW1wb3J0IHtwcm9taXNpZnl9IGZyb20gJ2JsdWViaXJkJztcbmltcG9ydCB7Q2xpZW50fSBmcm9tICdzc2gyJztcbmltcG9ydCBwYXRoIGZyb20gJ3BhdGgnO1xuXG5leHBvcnQgZnVuY3Rpb24gcnVuVGFza0xpc3QobGlzdCwgc2Vzc2lvbnMsIG9wdHMpIHtcbiAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICBsaXN0LnJ1bihzZXNzaW9ucywgb3B0cywgc3VtbWFyeU1hcCA9PiB7XG4gICAgICBmb3IgKHZhciBob3N0IGluIHN1bW1hcnlNYXApIHtcbiAgICAgICAgY29uc3Qgc3VtbWFyeSA9IHN1bW1hcnlNYXBbaG9zdF07XG4gICAgICAgIGlmIChzdW1tYXJ5LmVycm9yKSB7XG4gICAgICAgICAgcmVqZWN0KHN1bW1hcnkuZXJyb3IpO1xuICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuICAgICAgfVxuXG4gICAgICByZXNvbHZlKCk7XG4gICAgfSk7XG4gIH0pO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gZ2V0RG9ja2VyTG9ncyhuYW1lLCBzZXNzaW9ucywgYXJncykge1xuICBjb25zdCBjb21tYW5kID0gJ3N1ZG8gZG9ja2VyICcgKyBhcmdzLmpvaW4oJyAnKSArICcgJyArIG5hbWU7XG5cbiAgdmFyIHByb21pc2VzID0gXy5tYXAoc2Vzc2lvbnMsIHNlc3Npb24gPT4ge1xuICAgIHZhciBob3N0ID0gJ1snICsgc2Vzc2lvbi5faG9zdCArICddJztcbiAgICB2YXIgb3B0aW9ucyA9IHtcbiAgICAgIG9uU3Rkb3V0OiBkYXRhID0+IHtcbiAgICAgICAgcHJvY2Vzcy5zdGRvdXQud3JpdGUoaG9zdCArIGRhdGEpO1xuICAgICAgfSxcbiAgICAgIG9uU3RkZXJyOiBkYXRhID0+IHtcbiAgICAgICAgcHJvY2Vzcy5zdGRvdXQud3JpdGUoaG9zdCArIGRhdGEpO1xuICAgICAgfVxuICAgIH07XG4gICAgcmV0dXJuIHByb21pc2lmeShzZXNzaW9uLmV4ZWN1dGUuYmluZChzZXNzaW9uKSkoY29tbWFuZCwgb3B0aW9ucyk7XG4gIH0pO1xuICByZXR1cm4gUHJvbWlzZS5hbGwocHJvbWlzZXMpO1xufVxuXG4vLyBNYXliZSB3ZSBzaG91bGQgY3JlYXRlIGEgbmV3IG5wbSBwYWNrYWdlXG4vLyBmb3IgdGhpcyBvbmUuIFNvbWV0aGluZyBsaWtlICdzc2hlbGxqcycuXG5leHBvcnQgZnVuY3Rpb24gcnVuU1NIQ29tbWFuZChpbmZvLCBjb21tYW5kKSB7XG4gIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgY29uc3QgY29ubiA9IG5ldyBDbGllbnQoKTtcblxuICAgIC8vIFRPRE8gYmV0dGVyIGlmIHdlIGNhbiBleHRyYWN0IFNTSCBhZ2VudCBpbmZvIGZyb20gb3JpZ2luYWwgc2Vzc2lvblxuICAgIHZhciBzc2hBZ2VudCA9IHByb2Nlc3MuZW52LlNTSF9BVVRIX1NPQ0s7XG4gICAgdmFyIHNzaCA9IHtcbiAgICAgIGhvc3Q6IGluZm8uaG9zdCxcbiAgICAgIHBvcnQ6IChpbmZvLm9wdHMgJiYgaW5mby5vcHRzLnBvcnQgfHwgMjIpLFxuICAgICAgdXNlcm5hbWU6IGluZm8udXNlcm5hbWVcbiAgICB9O1xuXG4gICAgaWYgKGluZm8ucGVtKSB7XG4gICAgICBzc2gucHJpdmF0ZUtleSA9IGZzLnJlYWRGaWxlU3luYyhwYXRoLnJlc29sdmUoaW5mby5wZW0pLCAndXRmOCcpO1xuICAgIH0gZWxzZSBpZiAoaW5mby5wYXNzd29yZCkge1xuICAgICAgc3NoLnBhc3N3b3JkID0gaW5mby5wYXNzd29yZDtcbiAgICB9IGVsc2UgaWYgKHNzaEFnZW50ICYmIGZzLmV4aXN0c1N5bmMoc3NoQWdlbnQpKSB7XG4gICAgICBzc2guYWdlbnQgPSBzc2hBZ2VudDtcbiAgICB9XG4gICAgY29ubi5jb25uZWN0KHNzaCk7XG5cbiAgICBjb25uLm9uY2UoJ2Vycm9yJywgZnVuY3Rpb24gKGVycikge1xuICAgICAgaWYgKGVycikge1xuICAgICAgICByZWplY3QoZXJyKTtcbiAgICAgIH1cbiAgICB9KTtcblxuICAgIC8vIFRPRE8gaGFuZGxlIGVycm9yIGV2ZW50c1xuICAgIGNvbm4ub25jZSgncmVhZHknLCBmdW5jdGlvbiAoKSB7XG4gICAgICBjb25uLmV4ZWMoY29tbWFuZCwgZnVuY3Rpb24gKGVyciwgc3RyZWFtKSB7XG4gICAgICAgIGlmIChlcnIpIHtcbiAgICAgICAgICBjb25uLmVuZCgpO1xuICAgICAgICAgIHJlamVjdChlcnIpO1xuICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuXG4gICAgICAgIGxldCBvdXRwdXQgPSAnJztcblxuICAgICAgICBzdHJlYW0ub24oJ2RhdGEnLCBmdW5jdGlvbiAoZGF0YSkge1xuICAgICAgICAgIG91dHB1dCArPSBkYXRhO1xuICAgICAgICB9KTtcblxuICAgICAgICBzdHJlYW0ub25jZSgnY2xvc2UnLCBmdW5jdGlvbiAoY29kZSkge1xuICAgICAgICAgIGNvbm4uZW5kKCk7XG4gICAgICAgICAgcmVzb2x2ZSh7Y29kZSwgb3V0cHV0fSk7XG4gICAgICAgIH0pO1xuICAgICAgfSk7XG4gICAgfSk7XG4gIH0pO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gY291bnRPY2N1cmVuY2VzKG5lZWRsZSwgaGF5c3RhY2spIHtcbiAgY29uc3QgcmVnZXggPSBuZXcgUmVnRXhwKG5lZWRsZSwgJ2cnKTtcbiAgY29uc3QgbWF0Y2ggPSBoYXlzdGFjay5tYXRjaChyZWdleCkgfHwgW107XG4gIHJldHVybiBtYXRjaC5sZW5ndGg7XG59XG4iXX0=